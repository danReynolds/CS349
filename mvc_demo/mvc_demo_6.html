<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>MVC demo 6</title>
</head>
<body>

<div id="app">

    <template id="excitement_level_text_view_template">
        Your current excitement level is: <span class="excitement_span">1</span>
    </template>

    <template id="excitement_level_slider_template">
        Set your excitement level: <input type="range" class="excitement_slider"/>
    </template>

    <script id="excitement_level_buttons_template" type="text/html">
        <button class="decrement_button">Lower Your Excitement</button>
        <button class="increment_button">Increase Your Excitement</button>
    </script>
</div>

<button id="make_ui_button" style="margin-top: 20px;">
    Make User Interface
</button>

<div style="margin-top: 40px;">
    <a href="mvc_demo_5.html">Previous demo (MVC 5)</a>
    <a href="mvc_demo_7.html">Previous demo (MVC 7)</a>
</div>

<!--
    Underscore will create a variable named _ that will provide a bunch of functionality.
    We'll use its functional aspects
-->
<script src="ext/underscore.js"></script>
<script>

    /*
    In this demo, we now wire up the interface to respond to events, and reintroduce our
    model.
     */

    function createModule() {
        // Define our classes

        // Our model remains the same
        var ExcitementModel = function () {
            this.listeners = [];
            this.excitement = 1;

            this.setExcitement = function (value) {

                // Transform value to a number, if it's not already
                this.excitement = parseInt(value) || 1;

                // Notify our listeners
                // Save a reference to this for the function call below
                var model = this;
                // Use underscore to iterate over all listeners, calling each in turn
                _.each(
                        this.listeners,
                        function (listener_fn) {
                            listener_fn(model, value);
                        }
                );
            };

            this.getExcitement = function () {
                return this.excitement;
            };

            // Signature for listener_fn: (model, newValue)
            this.addListener = function (listener_fn) {
                this.listeners.push(listener_fn);
            };
        };

        // Define our views
        var AbstractView = function () {
        };

        _.extend(AbstractView.prototype, {
            _instantiateInterface: function (templateId, attachToElement) {
                var template = document.getElementById(templateId);
                this.hostElement = document.createElement('div');
                this.hostElement.innerHTML = template.innerHTML;
                attachToElement.appendChild(this.hostElement);
            }
        });

        var ExcitementTextView = function (attachToElement, excitementModel) {
            this._instantiateInterface('excitement_level_text_view_template', attachToElement);

            var span = this.hostElement.getElementsByClassName('excitement_span')[0];
            span.innerText = excitementModel.getExcitement();
            excitementModel.addListener(function (model, newValue) {
                span.innerText = newValue;
            });
        };
        _.extend(ExcitementTextView.prototype, AbstractView.prototype);

        var ExcitementSlider = function (attachToElement, excitementModel) {
            this._instantiateInterface('excitement_level_slider_template', attachToElement);

            var slider = this.hostElement.getElementsByClassName('excitement_slider')[0];
            slider.min = 1;
            slider.max = 11;
            slider.value = excitementModel.getExcitement();

            / * controller example */
            slider.addEventListener('input', function () {
                excitementModel.setExcitement(slider.value);
            });

            / * controller example */
            excitementModel.addListener(function (model, newValue) {
                slider.value = newValue;
            });
        };
        _.extend(ExcitementSlider.prototype, AbstractView.prototype);

        var ExcitementButtons = function (attachToElement, excitementModel) {
            this._instantiateInterface('excitement_level_buttons_template', attachToElement);

            var decrementButton = this.hostElement.getElementsByClassName('decrement_button')[0];
            decrementButton.addEventListener('click', function () {
                excitementModel.setExcitement(excitementModel.getExcitement() - 1);
            });

            var incrementButton = this.hostElement.getElementsByClassName('increment_button')[0];
            incrementButton.addEventListener('click', function () {
                excitementModel.setExcitement(excitementModel.getExcitement() + 1);
            });
        };
        _.extend(ExcitementButtons.prototype, AbstractView.prototype);

        return {
            ExcitementModel: ExcitementModel,
            ExcitementTextView: ExcitementTextView,
            ExcitementSlider:  ExcitementSlider,
            ExcitementButtons: ExcitementButtons
        };
    }

    window.addEventListener('load', function() {
        var classes = createModule();
        var excitementModel = new classes.ExcitementModel();
        var makeUIButton = document.getElementById('make_ui_button');
        makeUIButton.addEventListener('click', function() {
            makeUI(classes, excitementModel);
        });
    });

    function makeUI(classes, excitementModel) {
        var appDiv = document.getElementById('app');
        var textView = new classes.ExcitementTextView(appDiv, excitementModel);
        var sliderView = new classes.ExcitementSlider(appDiv, excitementModel);
        var buttonsView = new classes.ExcitementButtons(appDiv, excitementModel);
    }

    /*
    This code is now far more modular, and allows us to separate out our various concerns.
    Creating a new view or widget is a well-defined process, and now we don't have to
    hunt through the global DOM to update widgets: we can make changes locally.

    To see another example of an MVC architecture like this, see Backbone:
    http://backbonejs.org/docs/backbone.html

    In the next demo, we'll create another view, just to show off the modularity of
    the architecture, and the benefits of MVC
     */

    // Original author: Michael Terry (mterry@cs.uwaterloo.ca)
</script>
</body>
</html>